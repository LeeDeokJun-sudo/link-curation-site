<script type="module">
    // Firebase SDK 최신 안정 버전으로 변경
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-app.js";
    import { getFirestore, collection, getDocs, query, orderBy, where } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-firestore.js";
    
    const firebaseConfig = {
        apiKey: "AIzaSyDzPalx0dYavQNN12N9IXAElO9sMZRT3Hk",
        authDomain: "artist-reference-2025-a0ed1.firebaseapp.com",
        projectId: "artist-reference-2025-a0ed1",
        storageBucket: "artist-reference-2025-a0ed1.firebasestorage.app",
        messagingSenderId: "478548583901",
        appId: "1:478548583901:web:21f3e6462bd3fc7ce7c234"
    };

    let db;
    let app;
    
    // Firebase 초기화 (개선된 에러 핸들링)
    try {
        app = initializeApp(firebaseConfig);
        db = getFirestore(app);
        console.log("✅ Firebase 초기화 성공");
    } catch (e) {
        console.error("❌ Firebase 초기화 실패:", e.message);
        console.error("전체 오류:", e);
        document.getElementById('links-container').innerHTML = `
            <div class="text-center text-red-500 py-16">
                🚨 Firebase 연결 실패<br>
                오류: ${e.message}<br>
                <small class="text-gray-400">콘솔(F12)에서 자세한 오류를 확인하세요</small>
            </div>`;
    }

    const linksContainer = document.getElementById('links-container');

    const createLinkElement = (link, isTrending = false) => {
        const colorClass = link.color || 'text-white';
        const url = link.url || '#';
        const name = typeof link.name === 'string' ? link.name : '이름 없음';
        const description = typeof link.description === 'string' ? link.description : '설명 없음';
        const rank = link.rank_order > 0 ? link.rank_order : null;

        let rankingBadge = '';
        if (isTrending && rank) {
            rankingBadge = `<span class="ranking-badge bg-red-600">BEST ${rank}</span>`;
        }

        return `
            <a href="${url}" target="_blank" class="block bg-gray-900 rounded-lg overflow-hidden shadow-2xl transition duration-300 hover:shadow-indigo-500/50 hover:scale-[1.02] cursor-pointer relative">
                ${rankingBadge}
                <div class="ratio-4-to-1">
                    <div class="item-content ${colorClass}">
                        <span class="text-xl font-extrabold mb-1 whitespace-normal">${name}</span>
                        <span class="text-sm sm:text-xs font-medium text-gray-400 whitespace-normal leading-tight">${description}</span>
                    </div>
                </div>
            </a>
        `;
    };

    const loadLinks = async () => {
        if (!db) {
            console.error("❌ Firestore DB가 초기화되지 않았습니다");
            return;
        }

        console.log("🔄 데이터 로딩 시작...");
        
        try {
            // 1. Trending Links 로드
            console.log("📊 Trending 링크 조회 중...");
            const trendingQuery = query(
                collection(db, "links"),
                where("is_trending", "==", true),
                orderBy("rank_order", "asc")
            );
            const trendingSnapshot = await getDocs(trendingQuery);
            const trendingLinks = [];
            trendingSnapshot.forEach((doc) => {
                trendingLinks.push({ id: doc.id, ...doc.data() });
            });
            console.log(`✅ Trending 링크 ${trendingLinks.length}개 로드됨`);

            // 2. All Links 로드
            console.log("📊 전체 링크 조회 중...");
            const allQuery = collection(db, "links");
            const allSnapshot = await getDocs(allQuery);
            const allLinks = [];
            allSnapshot.forEach((doc) => {
                allLinks.push({ id: doc.id, ...doc.data() });
            });
            console.log(`✅ 전체 링크 ${allLinks.length}개 로드됨`);

            // Trending 제외한 일반 링크 필터링
            const trendingIds = new Set(trendingLinks.map(link => link.id));
            const normalLinks = allLinks.filter(link => !trendingIds.has(link.id));
            
            // 카테고리별 그룹화
            const groupedLinks = normalLinks.reduce((acc, link) => {
                const category = typeof link.category === 'string' && link.category.trim() !== '' ? link.category : '기타';
                if (!acc[category]) {
                    acc[category] = [];
                }
                acc[category].push(link);
                return acc;
            }, {});

            // 로딩 메시지 제거
            linksContainer.innerHTML = ''; 

            // TRENDING NOW 섹션
            if (trendingLinks.length > 0) {
                const trendingHeader = document.createElement('h2');
                trendingHeader.className = 'text-2xl font-bold mb-4 mt-8 tracking-wider text-indigo-400 border-b border-indigo-700 pb-2';
                trendingHeader.textContent = '🔥 TRENDING NOW';
                linksContainer.appendChild(trendingHeader);

                const trendingContent = document.createElement('main');
                trendingContent.className = 'grid grid-4-cols gap-3 sm:gap-4 mb-12';
                
                trendingLinks.forEach(link => {
                    trendingContent.innerHTML += createLinkElement(link, true);
                });
                linksContainer.appendChild(trendingContent);
            }

            // 카테고리별 섹션
            const categories = ['AI TOOLS', 'CAREER & JOB', 'VIDEO', 'DESIGN & PORTFOLIO'];

            categories.forEach(category => {
                const links = groupedLinks[category];
                if (links && links.length > 0) {
                    const categoryHeader = document.createElement('h2');
                    categoryHeader.className = 'text-2xl font-bold mb-4 mt-8 tracking-wider text-gray-300 border-b border-gray-700 pb-2';
                    categoryHeader.textContent = category;
                    linksContainer.appendChild(categoryHeader);

                    const mainContent = document.createElement('main');
                    mainContent.className = 'grid grid-4-cols gap-3 sm:gap-4 mb-12';

                    links.forEach(link => {
                        mainContent.innerHTML += createLinkElement(link, false);
                    });
                    linksContainer.appendChild(mainContent);
                }
            });

            if (allLinks.length === 0) {
                linksContainer.innerHTML = '<div class="text-center text-yellow-500 py-16">⚠️ 데이터베이스가 비어있습니다</div>';
            }

            console.log("✅ 데이터 로딩 완료!");

        } catch (e) {
            console.error("❌ 데이터 로딩 중 오류:", e.message);
            console.error("전체 오류:", e);
            console.error("오류 코드:", e.code);
            
            linksContainer.innerHTML = `
                <div class="text-center text-red-500 py-16">
                    🚨 데이터 로딩 실패<br>
                    <strong>오류:</strong> ${e.message}<br>
                    <strong>코드:</strong> ${e.code || 'N/A'}<br><br>
                    <div class="text-sm text-gray-400 mt-4">
                        <p>가능한 원인:</p>
                        <ul class="list-disc list-inside mt-2">
                            <li>Firestore 보안 규칙이 읽기를 차단함</li>
                            <li>인덱스가 생성되지 않음</li>
                            <li>네트워크 연결 문제</li>
                        </ul>
                        <p class="mt-4">콘솔(F12)에서 자세한 내용을 확인하세요</p>
                    </div>
                </div>`;
        }
    };

    // DOM 로드 후 실행
    document.addEventListener('DOMContentLoaded', () => {
        console.log("🚀 페이지 로드 완료, Firebase 연결 시작");
        loadLinks();
        
        // 필터 버튼 로직
        const searchForm = document.getElementById('google-search-form');
        const filterButtons = document.querySelectorAll('.filter-btn');

        filterButtons.forEach(button => {
            button.addEventListener('click', () => {
                const keyword = button.getAttribute('data-keyword');
                document.getElementById('search-input').value = keyword;
                searchForm.submit();
            });
        });
    });

    // Lucide 아이콘 로드
    setTimeout(() => {
        if(typeof lucide !== 'undefined' && lucide.createIcons) {
            lucide.createIcons();
        }
    }, 100); 
</script>
