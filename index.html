<script type="module">
    // Firebase SDK ìµœì‹  ì•ˆì • ë²„ì „ìœ¼ë¡œ ë³€ê²½
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-app.js";
    import { getFirestore, collection, getDocs, query, orderBy, where } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-firestore.js";
    
    const firebaseConfig = {
        apiKey: "AIzaSyDzPalx0dYavQNN12N9IXAElO9sMZRT3Hk",
        authDomain: "artist-reference-2025-a0ed1.firebaseapp.com",
        projectId: "artist-reference-2025-a0ed1",
        storageBucket: "artist-reference-2025-a0ed1.firebasestorage.app",
        messagingSenderId: "478548583901",
        appId: "1:478548583901:web:21f3e6462bd3fc7ce7c234"
    };

    let db;
    let app;
    
    // Firebase ì´ˆê¸°í™” (ê°œì„ ëœ ì—ëŸ¬ í•¸ë“¤ë§)
    try {
        app = initializeApp(firebaseConfig);
        db = getFirestore(app);
        console.log("âœ… Firebase ì´ˆê¸°í™” ì„±ê³µ");
    } catch (e) {
        console.error("âŒ Firebase ì´ˆê¸°í™” ì‹¤íŒ¨:", e.message);
        console.error("ì „ì²´ ì˜¤ë¥˜:", e);
        document.getElementById('links-container').innerHTML = `
            <div class="text-center text-red-500 py-16">
                ğŸš¨ Firebase ì—°ê²° ì‹¤íŒ¨<br>
                ì˜¤ë¥˜: ${e.message}<br>
                <small class="text-gray-400">ì½˜ì†”(F12)ì—ì„œ ìì„¸í•œ ì˜¤ë¥˜ë¥¼ í™•ì¸í•˜ì„¸ìš”</small>
            </div>`;
    }

    const linksContainer = document.getElementById('links-container');

    const createLinkElement = (link, isTrending = false) => {
        const colorClass = link.color || 'text-white';
        const url = link.url || '#';
        const name = typeof link.name === 'string' ? link.name : 'ì´ë¦„ ì—†ìŒ';
        const description = typeof link.description === 'string' ? link.description : 'ì„¤ëª… ì—†ìŒ';
        const rank = link.rank_order > 0 ? link.rank_order : null;

        let rankingBadge = '';
        if (isTrending && rank) {
            rankingBadge = `<span class="ranking-badge bg-red-600">BEST ${rank}</span>`;
        }

        return `
            <a href="${url}" target="_blank" class="block bg-gray-900 rounded-lg overflow-hidden shadow-2xl transition duration-300 hover:shadow-indigo-500/50 hover:scale-[1.02] cursor-pointer relative">
                ${rankingBadge}
                <div class="ratio-4-to-1">
                    <div class="item-content ${colorClass}">
                        <span class="text-xl font-extrabold mb-1 whitespace-normal">${name}</span>
                        <span class="text-sm sm:text-xs font-medium text-gray-400 whitespace-normal leading-tight">${description}</span>
                    </div>
                </div>
            </a>
        `;
    };

    const loadLinks = async () => {
        if (!db) {
            console.error("âŒ Firestore DBê°€ ì´ˆê¸°í™”ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤");
            return;
        }

        console.log("ğŸ”„ ë°ì´í„° ë¡œë”© ì‹œì‘...");
        
        try {
            // 1. Trending Links ë¡œë“œ
            console.log("ğŸ“Š Trending ë§í¬ ì¡°íšŒ ì¤‘...");
            const trendingQuery = query(
                collection(db, "links"),
                where("is_trending", "==", true),
                orderBy("rank_order", "asc")
            );
            const trendingSnapshot = await getDocs(trendingQuery);
            const trendingLinks = [];
            trendingSnapshot.forEach((doc) => {
                trendingLinks.push({ id: doc.id, ...doc.data() });
            });
            console.log(`âœ… Trending ë§í¬ ${trendingLinks.length}ê°œ ë¡œë“œë¨`);

            // 2. All Links ë¡œë“œ
            console.log("ğŸ“Š ì „ì²´ ë§í¬ ì¡°íšŒ ì¤‘...");
            const allQuery = collection(db, "links");
            const allSnapshot = await getDocs(allQuery);
            const allLinks = [];
            allSnapshot.forEach((doc) => {
                allLinks.push({ id: doc.id, ...doc.data() });
            });
            console.log(`âœ… ì „ì²´ ë§í¬ ${allLinks.length}ê°œ ë¡œë“œë¨`);

            // Trending ì œì™¸í•œ ì¼ë°˜ ë§í¬ í•„í„°ë§
            const trendingIds = new Set(trendingLinks.map(link => link.id));
            const normalLinks = allLinks.filter(link => !trendingIds.has(link.id));
            
            // ì¹´í…Œê³ ë¦¬ë³„ ê·¸ë£¹í™”
            const groupedLinks = normalLinks.reduce((acc, link) => {
                const category = typeof link.category === 'string' && link.category.trim() !== '' ? link.category : 'ê¸°íƒ€';
                if (!acc[category]) {
                    acc[category] = [];
                }
                acc[category].push(link);
                return acc;
            }, {});

            // ë¡œë”© ë©”ì‹œì§€ ì œê±°
            linksContainer.innerHTML = ''; 

            // TRENDING NOW ì„¹ì…˜
            if (trendingLinks.length > 0) {
                const trendingHeader = document.createElement('h2');
                trendingHeader.className = 'text-2xl font-bold mb-4 mt-8 tracking-wider text-indigo-400 border-b border-indigo-700 pb-2';
                trendingHeader.textContent = 'ğŸ”¥ TRENDING NOW';
                linksContainer.appendChild(trendingHeader);

                const trendingContent = document.createElement('main');
                trendingContent.className = 'grid grid-4-cols gap-3 sm:gap-4 mb-12';
                
                trendingLinks.forEach(link => {
                    trendingContent.innerHTML += createLinkElement(link, true);
                });
                linksContainer.appendChild(trendingContent);
            }

            // ì¹´í…Œê³ ë¦¬ë³„ ì„¹ì…˜
            const categories = ['AI TOOLS', 'CAREER & JOB', 'VIDEO', 'DESIGN & PORTFOLIO'];

            categories.forEach(category => {
                const links = groupedLinks[category];
                if (links && links.length > 0) {
                    const categoryHeader = document.createElement('h2');
                    categoryHeader.className = 'text-2xl font-bold mb-4 mt-8 tracking-wider text-gray-300 border-b border-gray-700 pb-2';
                    categoryHeader.textContent = category;
                    linksContainer.appendChild(categoryHeader);

                    const mainContent = document.createElement('main');
                    mainContent.className = 'grid grid-4-cols gap-3 sm:gap-4 mb-12';

                    links.forEach(link => {
                        mainContent.innerHTML += createLinkElement(link, false);
                    });
                    linksContainer.appendChild(mainContent);
                }
            });

            if (allLinks.length === 0) {
                linksContainer.innerHTML = '<div class="text-center text-yellow-500 py-16">âš ï¸ ë°ì´í„°ë² ì´ìŠ¤ê°€ ë¹„ì–´ìˆìŠµë‹ˆë‹¤</div>';
            }

            console.log("âœ… ë°ì´í„° ë¡œë”© ì™„ë£Œ!");

        } catch (e) {
            console.error("âŒ ë°ì´í„° ë¡œë”© ì¤‘ ì˜¤ë¥˜:", e.message);
            console.error("ì „ì²´ ì˜¤ë¥˜:", e);
            console.error("ì˜¤ë¥˜ ì½”ë“œ:", e.code);
            
            linksContainer.innerHTML = `
                <div class="text-center text-red-500 py-16">
                    ğŸš¨ ë°ì´í„° ë¡œë”© ì‹¤íŒ¨<br>
                    <strong>ì˜¤ë¥˜:</strong> ${e.message}<br>
                    <strong>ì½”ë“œ:</strong> ${e.code || 'N/A'}<br><br>
                    <div class="text-sm text-gray-400 mt-4">
                        <p>ê°€ëŠ¥í•œ ì›ì¸:</p>
                        <ul class="list-disc list-inside mt-2">
                            <li>Firestore ë³´ì•ˆ ê·œì¹™ì´ ì½ê¸°ë¥¼ ì°¨ë‹¨í•¨</li>
                            <li>ì¸ë±ìŠ¤ê°€ ìƒì„±ë˜ì§€ ì•ŠìŒ</li>
                            <li>ë„¤íŠ¸ì›Œí¬ ì—°ê²° ë¬¸ì œ</li>
                        </ul>
                        <p class="mt-4">ì½˜ì†”(F12)ì—ì„œ ìì„¸í•œ ë‚´ìš©ì„ í™•ì¸í•˜ì„¸ìš”</p>
                    </div>
                </div>`;
        }
    };

    // DOM ë¡œë“œ í›„ ì‹¤í–‰
    document.addEventListener('DOMContentLoaded', () => {
        console.log("ğŸš€ í˜ì´ì§€ ë¡œë“œ ì™„ë£Œ, Firebase ì—°ê²° ì‹œì‘");
        loadLinks();
        
        // í•„í„° ë²„íŠ¼ ë¡œì§
        const searchForm = document.getElementById('google-search-form');
        const filterButtons = document.querySelectorAll('.filter-btn');

        filterButtons.forEach(button => {
            button.addEventListener('click', () => {
                const keyword = button.getAttribute('data-keyword');
                document.getElementById('search-input').value = keyword;
                searchForm.submit();
            });
        });
    });

    // Lucide ì•„ì´ì½˜ ë¡œë“œ
    setTimeout(() => {
        if(typeof lucide !== 'undefined' && lucide.createIcons) {
            lucide.createIcons();
        }
    }, 100); 
</script>
